#!/bin/bash

# Archy - Local AI Assistant CLI
# Simple wrapper to interact with Archy AI assistant

# Determine the Archy project directory
# First try to find it relative to where this script might be installed
if [[ -f "/home/chef/Archy/.env" ]]; then
    ARCHY_DIR="/home/chef/Archy"
elif [[ -f "$HOME/Archy/.env" ]]; then
    ARCHY_DIR="$HOME/Archy"
else
    # Fallback to current directory or script directory
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    ARCHY_DIR="$(dirname "$SCRIPT_DIR")"
fi

# Load .env file if it exists
if [[ -f "$ARCHY_DIR/.env" ]]; then
    # Export variables defined in .env safely
    set -a
    # shellcheck disable=SC1090
    source "$ARCHY_DIR/.env"
    set +a
fi

# Load .api secrets file if it exists (export variables)
if [[ -f "$ARCHY_DIR/.api" ]]; then
    # Use a subshell to avoid polluting current shell when source fails
    set -a
    # shellcheck disable=SC1090
    source "$ARCHY_DIR/.api"
    set +a
fi

ARCHY_HOME="${ARCHY_HOME:-$HOME/.archy}"
MODEL_PROVIDER="${MODEL_PROVIDER:-gemini}"

# Color codes
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Functions
print_info() {
    echo -e "${BLUE}[*]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[+]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[!]${NC} $1"
}

print_error() {
    echo -e "${RED}[-]${NC} $1"
}

show_help() {
    cat <<EOF
${GREEN}Archy - Local AI Assistant${NC}

Usage: archy [command] [options]

Commands:
  help              Show this help message
  chat              Enter interactive chat mode
  chat [question]   Ask Archy a single question

Examples:
  archy chat                    # Interactive chat
  archy chat "what tools do I have?"
  archy "what is arch linux?"

For more info: https://github.com/NerfedChou/Archy
EOF
}

# Cleanup function called on exit
cleanup() {
    :
}

# Set trap to call cleanup on exit
trap cleanup EXIT INT TERM

# Daemon is now managed by systemd service
# Just verify it's available
check_daemon_running() {
    # Check if the socket exists and is listening
    if [[ -S /tmp/archy.sock ]]; then
        return 0
    fi
    return 1
}

# Detect if running under sudo
SUDO_USER="${SUDO_USER:-}"
RUNNING_AS_ROOT=$([[ $EUID -eq 0 ]] && echo "true" || echo "false")

# If daemon isn't running, try starting the service
if ! check_daemon_running; then
    print_warning "Daemon not responding. Starting systemd service..."

    # If running as root via sudo, we need to start the user's service session
    if [[ "$RUNNING_AS_ROOT" == "true" && -n "$SUDO_USER" ]]; then
        print_info "Running as root (via sudo), starting service for user: $SUDO_USER"
        # Run systemctl as the original user
        sudo -u "$SUDO_USER" systemctl --user start archy-executor.service 2>/dev/null
        sleep 1
    else
        # Normal user execution
        systemctl --user start archy-executor.service 2>/dev/null
        sleep 1
    fi

    if ! check_daemon_running; then
        print_error "Failed to start archy-executor service"
        if [[ "$RUNNING_AS_ROOT" == "true" && -n "$SUDO_USER" ]]; then
            print_info "Try: sudo -u $SUDO_USER systemctl --user start archy-executor.service"
            print_info "Or check status: sudo -u $SUDO_USER systemctl --user status archy-executor.service"
        else
            print_info "Try: systemctl --user start archy-executor.service"
            print_info "Or check status: systemctl --user status archy-executor.service"
        fi
        exit 1
    fi
fi

# Check if archy_chat.py exists
ARCHY_CHAT_PY="$ARCHY_DIR/scripts/archy_chat.py"
if [[ ! -f "$ARCHY_CHAT_PY" ]]; then
    print_error "archy_chat.py not found at: $ARCHY_CHAT_PY"
    exit 1
fi

# Main logic
if [[ $# -eq 0 ]]; then
    # No arguments: launch interactive chat mode
    print_success "Launching interactive chat..."
    exec python3 "$ARCHY_CHAT_PY"
    exit 0
fi

case "$1" in
    help)
        show_help
        ;;
    chat)
        # Interactive or single-question chat mode
        if [[ $# -eq 1 ]]; then
            # Interactive mode: archy chat
            print_success "Launching interactive chat..."
            exec python3 "$ARCHY_CHAT_PY"
        else
            # Single question mode: archy chat "question"
            shift  # Remove 'chat' from arguments
            exec python3 "$ARCHY_CHAT_PY" "$@"
        fi
        ;;
    *)
        # Default: treat as question for single-query mode
        exec python3 "$ARCHY_CHAT_PY" "$@"
        ;;
esac
